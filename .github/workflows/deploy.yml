name: Deploy Airflow to GCP VM

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: de6-2ez
          
      - name: Configure SSH key
        run: |
          # SSH í‚¤ ì„¤ì • (GCP ë©”íƒ€ë°ì´í„°ì—ì„œ ê´€ë¦¬ë˜ëŠ” ê²½ìš° ìƒëµ ê°€ëŠ¥)
          echo "SSH key configuration completed"
          
      - name: Deploy to VM
        run: |
          # VM ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
          gcloud compute instances describe airflow-vm \
            --zone=asia-northeast3-a \
            --project=de6-2ez \
            --format='get(status)' > vm_status.txt
          
          VM_STATUS=$(cat vm_status.txt)
          echo "VM Status: $VM_STATUS"
          
          if [ "$VM_STATUS" != "RUNNING" ]; then
            echo "Starting VM instance..."
            gcloud compute instances start airflow-vm \
              --zone=asia-northeast3-a \
              --project=de6-2ez
            
            # VM ì‹œì‘ ëŒ€ê¸°
            sleep 30
          fi
          
          # SSHë¡œ VMì— ì ‘ì†í•˜ì—¬ ë°°í¬ ì‹¤í–‰
          gcloud compute ssh ubuntu@airflow-vm \
            --zone=asia-northeast3-a \
            --project=de6-2ez \
            --ssh-flag="-o StrictHostKeyChecking=no" \
            --command="
              set -e
              echo 'ğŸš€ Starting deployment process...'
              
              # ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
              cd /opt/airflow || { echo 'Directory /opt/airflow not found'; exit 1; }
              
              # Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
              echo 'ğŸ“¦ Updating code from Git...'
              git fetch origin
              git reset --hard origin/main
              
              # Docker Compose ì„œë¹„ìŠ¤ ì¬ì‹œì‘
              echo 'ğŸ”„ Restarting Docker services...'
              docker-compose down
              docker-compose pull
              
              # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í•„ìš”í•œ ê²½ìš°)
              export AIRFLOW_UID=\$(id -u)
              export AIRFLOW_GID=0
              
              # ì„œë¹„ìŠ¤ ì‹œì‘
              docker-compose up -d
              
              echo 'âœ… Docker services started successfully'
            "
            
      - name: Wait for services to start
        run: |
          echo "â³ Waiting for services to initialize..."
          sleep 90
          
      - name: Health Check
        run: |
          # VMì˜ ì™¸ë¶€ IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          VM_IP=$(gcloud compute instances describe airflow-vm \
            --zone=asia-northeast3-a \
            --project=de6-2ez \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "VM External IP: $VM_IP"
          
          # Airflow ì›¹ì„œë²„ í—¬ìŠ¤ì²´í¬
          echo "ğŸ” Checking Airflow webserver health..."
          
          # ìµœëŒ€ 5ë¶„ê°„ í—¬ìŠ¤ì²´í¬ ì‹œë„
          for i in {1..10}; do
            if curl -f -s "http://$VM_IP:8080/health" > /dev/null 2>&1; then
              echo "âœ… Airflow webserver is healthy!"
              echo "ğŸ‰ Deployment successful!"
              echo "ğŸŒ Airflow UI: http://$VM_IP:8080"
              echo "ğŸ‘¤ Default login: airflow / airflow"
              exit 0
            else
              echo "â³ Attempt $i/10: Airflow not ready yet, waiting 30s..."
              sleep 30
            fi
          done
          
          echo "âŒ Health check failed - Airflow webserver not responding"
          echo "ğŸ” Checking container status..."
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          gcloud compute ssh ubuntu@airflow-vm \
            --zone=asia-northeast3-a \
            --project=de6-2ez \
            --ssh-flag="-o StrictHostKeyChecking=no" \
            --command="docker-compose ps"
          
          exit 1
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "ğŸ§¹ Deployment failed, checking logs..."
          
          # ì‹¤íŒ¨ ì‹œ ë¡œê·¸ í™•ì¸
          gcloud compute ssh ubuntu@airflow-vm \
            --zone=asia-northeast3-a \
            --project=de6-2ez \
            --ssh-flag="-o StrictHostKeyChecking=no" \
            --command="
              echo '=== Docker Compose Status ==='
              docker-compose ps
              
              echo '=== Airflow Webserver Logs ==='
              docker-compose logs --tail=50 airflow-webserver
              
              echo '=== Airflow Scheduler Logs ==='
              docker-compose logs --tail=50 airflow-scheduler
