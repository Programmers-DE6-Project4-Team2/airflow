name: Deploy Airflow DAGs to Cloud Composer

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: de6-2ez
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Verify authentication
        run: |
          gcloud auth list
          gcloud config list project
          echo "✅ Authentication successful"
          
      - name: Configure SSH key
        run: |
          # SSH 키 설정 (GCP 메타데이터에서 관리되는 경우 생략 가능)
          echo "SSH key configuration completed"
          
      - name: Deploy to Composer
        run: |
          # Composer 환경 정보
          COMPOSER_ENVIRONMENT_NAME="de6-2ez-composer"
          COMPOSER_LOCATION="asia-northeast3"
          
          echo "🚀 Deploying DAGs to Cloud Composer..."
          
          # DAG 파일들을 Composer 환경에 업로드
          echo "📦 Uploading DAG files to Composer..."
          gcloud composer environments storage dags import \
            --environment="$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --source="dags/oliveyoung_products_dag.py" \
            --project=de6-2ez
          
          gcloud composer environments storage dags import \
            --environment="$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --source="dags/oliveyoung_reviews_dag.py" \
            --project=de6-2ez
          
          # Common 모듈이 있다면 업로드
          if [ -d "common" ]; then
            echo "📦 Uploading common modules..."
            gcloud composer environments storage data import \
              --environment="$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --source="common/" \
              --destination="common/" \
              --project=de6-2ez
          fi
          
          echo "✅ DAG files uploaded successfully"
            
      - name: Health Check
        run: |
          # Composer 환경 정보
          COMPOSER_ENVIRONMENT_NAME="de6-2ez-composer"
          COMPOSER_LOCATION="asia-northeast3"
          
          echo "🔍 Checking Composer environment health..."
          
          # Composer 환경 상태 확인
          ENV_STATE=$(gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --project=de6-2ez \
            --format='get(state)')
          
          echo "Composer Environment State: $ENV_STATE"
          
          if [ "$ENV_STATE" = "RUNNING" ]; then
            echo "✅ Composer environment is healthy!"
            echo "🎉 Deployment successful!"
            
            # Composer 웹서버 URL 가져오기
            AIRFLOW_URI=$(gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --project=de6-2ez \
              --format='get(config.airflowUri)')
            
            echo "🌐 Airflow UI: $AIRFLOW_URI"
            echo "👤 Use your Google account to login"
            
            # DAG 상태 확인
            echo "📊 Checking DAG status..."
            gcloud composer environments run "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --project=de6-2ez \
              dags list || true
          else
            echo "❌ Composer environment is not running: $ENV_STATE"
            exit 1
          fi
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "🧹 Deployment failed, checking Composer environment..."
          
          # Composer 환경 상태 확인
          COMPOSER_ENVIRONMENT_NAME="de6-2ez-composer"
          COMPOSER_LOCATION="asia-northeast3"
          
          echo "=== Composer Environment Status ==="
          gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --project=de6-2ez \
            --format='table(state,createTime,updateTime)' || true
          
          echo "=== Recent Operations ==="
          gcloud composer operations list \
            --locations="$COMPOSER_LOCATION" \
            --project=de6-2ez \
            --limit=5 || true
