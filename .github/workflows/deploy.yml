name: Deploy Airflow DAGs to Cloud Composer

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ vars.PROJECT_ID || 'de6-2ez' }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Verify authentication
        run: |
          gcloud auth list
          gcloud config list project
          echo "‚úÖ Authentication successful"
          
      - name: Configure SSH key
        run: |
          # SSH ÌÇ§ ÏÑ§Ï†ï (GCP Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ÏóêÏÑú Í¥ÄÎ¶¨ÎêòÎäî Í≤ΩÏö∞ ÏÉùÎûµ Í∞ÄÎä•)
          echo "SSH key configuration completed"
          
      - name: Deploy to Composer
        run: |
          # Composer ÌôòÍ≤Ω Ï†ïÎ≥¥
          COMPOSER_ENVIRONMENT_NAME="${{ vars.COMPOSER_ENVIRONMENT_NAME || 'de6-2ez-airflow' }}"
          COMPOSER_LOCATION="${{ vars.COMPOSER_LOCATION || 'asia-northeast3' }}"
          PROJECT_ID="${{ vars.PROJECT_ID || 'de6-2ez' }}"
          
          echo "üöÄ Deploying DAGs to Cloud Composer..."
          
          # DAG ÌååÏùºÎì§ÏùÑ Composer ÌôòÍ≤ΩÏóê ÏóÖÎ°úÎìú
          echo "üì¶ Uploading DAG files to Composer..."
          
          # dags/ ÎîîÎ†âÌÜ†Î¶¨Ïóê .py ÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
          if ls dags/*.py 1> /dev/null 2>&1; then
            for dag_file in dags/*.py; do
              if [ -f "$dag_file" ]; then
                echo "Uploading $dag_file..."
                gcloud composer environments storage dags import \
                  --environment="$COMPOSER_ENVIRONMENT_NAME" \
                  --location="$COMPOSER_LOCATION" \
                  --source="$dag_file" \
                  --project="$PROJECT_ID"
              fi
            done
          else
            echo "No DAG files found in dags/ directory"
          fi
          
          
          echo "‚úÖ DAG files uploaded successfully"
            
      - name: Health Check
        run: |
          # Composer ÌôòÍ≤Ω Ï†ïÎ≥¥
          COMPOSER_ENVIRONMENT_NAME="${{ vars.COMPOSER_ENVIRONMENT_NAME || 'de6-2ez-airflow' }}"
          COMPOSER_LOCATION="${{ vars.COMPOSER_LOCATION || 'asia-northeast3' }}"
          PROJECT_ID="${{ vars.PROJECT_ID || 'de6-2ez' }}"
          
          echo "üîç Checking Composer environment health..."
          
          # Composer ÌôòÍ≤Ω ÏÉÅÌÉú ÌôïÏù∏
          ENV_STATE=$(gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --project="$PROJECT_ID" \
            --format='get(state)')
          
          echo "Composer Environment State: $ENV_STATE"
          
          if [ "$ENV_STATE" = "RUNNING" ]; then
            echo "‚úÖ Composer environment is healthy!"
            echo "üéâ Deployment successful!"
            
            # Composer ÏõπÏÑúÎ≤Ñ URL Í∞ÄÏ†∏Ïò§Í∏∞
            AIRFLOW_URI=$(gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --project="$PROJECT_ID" \
              --format='get(config.airflowUri)')
            
            echo "üåê Airflow UI: $AIRFLOW_URI"
            echo "üë§ Use your Google account to login"
            
            # DAG ÏÉÅÌÉú ÌôïÏù∏
            echo "üìä Checking DAG status..."
            gcloud composer environments run "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --project="$PROJECT_ID" \
              dags list || true
          else
            echo "‚ùå Composer environment is not running: $ENV_STATE"
            exit 1
          fi
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "üßπ Deployment failed, checking Composer environment..."
          
          # Composer ÌôòÍ≤Ω ÏÉÅÌÉú ÌôïÏù∏
          COMPOSER_ENVIRONMENT_NAME="${{ vars.COMPOSER_ENVIRONMENT_NAME || 'de6-2ez-airflow' }}"
          COMPOSER_LOCATION="${{ vars.COMPOSER_LOCATION || 'asia-northeast3' }}"
          PROJECT_ID="${{ vars.PROJECT_ID || 'de6-2ez' }}"
          
          echo "=== Composer Environment Status ==="
          gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --project="$PROJECT_ID" \
            --format='table(state,createTime,updateTime)' || true
          
          echo "=== Recent Operations ==="
          gcloud composer operations list \
            --locations="$COMPOSER_LOCATION" \
            --project="$PROJECT_ID" \
            --limit=5 || true
