name: Deploy Airflow DAGs to Cloud Composer

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ vars.PROJECT_ID || 'de6-2ez' }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Verify authentication
        run: |
          gcloud auth list
          gcloud config list project
          echo "âœ… Authentication successful"
          
      - name: Configure SSH key
        run: |
          # SSH í‚¤ ì„¤ì • (GCP ë©”íƒ€ë°ì´í„°ì—ì„œ ê´€ë¦¬ë˜ëŠ” ê²½ìš° ìƒëµ ê°€ëŠ¥)
          echo "SSH key configuration completed"
          
      - name: Deploy to Composer
        run: |
          # Composer í™˜ê²½ ì •ë³´
          COMPOSER_ENVIRONMENT_NAME="${{ vars.COMPOSER_ENVIRONMENT_NAME || 'de6-2ez-airflow' }}"
          COMPOSER_LOCATION="${{ vars.COMPOSER_LOCATION || 'asia-northeast3' }}"
          PROJECT_ID="${{ vars.PROJECT_ID || 'de6-2ez' }}"
          
          echo "ğŸš€ Deploying DAGs to Cloud Composer..."
          
          # DAG íŒŒì¼ë“¤ì„ Composer í™˜ê²½ì— ì—…ë¡œë“œ
          echo "ğŸ“¦ Uploading DAG files to Composer..."
          
          # dags/ ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ ì—…ë¡œë“œ (common ë””ë ‰í† ë¦¬ í¬í•¨)
          echo "Uploading entire dags/ directory..."
          gcloud composer environments storage dags import \
            --environment="$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --source="dags/" \
            --project="$PROJECT_ID"
          
          # requirements.txt ì—…ë¡œë“œ (PyPI íŒ¨í‚¤ì§€ ê´€ë¦¬)
          if [ -f "requirements.txt" ]; then
            echo "ğŸ“¦ Uploading requirements.txt..."
            gcloud composer environments update "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --update-pypi-packages-from-file="requirements.txt" \
              --project="$PROJECT_ID"
            echo "âœ… Requirements updated successfully"
          else
            echo "âš ï¸ No requirements.txt found, skipping package updates"
          fi
          
          
          echo "âœ… DAG files uploaded successfully"
            
      - name: Health Check
        run: |
          # Composer í™˜ê²½ ì •ë³´
          COMPOSER_ENVIRONMENT_NAME="${{ vars.COMPOSER_ENVIRONMENT_NAME || 'de6-2ez-airflow' }}"
          COMPOSER_LOCATION="${{ vars.COMPOSER_LOCATION || 'asia-northeast3' }}"
          PROJECT_ID="${{ vars.PROJECT_ID || 'de6-2ez' }}"
          
          echo "ğŸ” Checking Composer environment health..."
          
          # Composer í™˜ê²½ ìƒíƒœ í™•ì¸
          ENV_STATE=$(gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --project="$PROJECT_ID" \
            --format='get(state)')
          
          echo "Composer Environment State: $ENV_STATE"
          
          if [ "$ENV_STATE" = "RUNNING" ]; then
            echo "âœ… Composer environment is healthy!"
            echo "ğŸ‰ Deployment successful!"
            
            # Composer ì›¹ì„œë²„ URL ê°€ì ¸ì˜¤ê¸°
            AIRFLOW_URI=$(gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --project="$PROJECT_ID" \
              --format='get(config.airflowUri)')
            
            echo "ğŸŒ Airflow UI: $AIRFLOW_URI"
            echo "ğŸ‘¤ Use your Google account to login"
            
            # DAG ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Checking DAG status..."
            gcloud composer environments run "$COMPOSER_ENVIRONMENT_NAME" \
              --location="$COMPOSER_LOCATION" \
              --project="$PROJECT_ID" \
              dags list || true
          else
            echo "âŒ Composer environment is not running: $ENV_STATE"
            exit 1
          fi
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "ğŸ§¹ Deployment failed, checking Composer environment..."
          
          # Composer í™˜ê²½ ìƒíƒœ í™•ì¸
          COMPOSER_ENVIRONMENT_NAME="${{ vars.COMPOSER_ENVIRONMENT_NAME || 'de6-2ez-airflow' }}"
          COMPOSER_LOCATION="${{ vars.COMPOSER_LOCATION || 'asia-northeast3' }}"
          PROJECT_ID="${{ vars.PROJECT_ID || 'de6-2ez' }}"
          
          echo "=== Composer Environment Status ==="
          gcloud composer environments describe "$COMPOSER_ENVIRONMENT_NAME" \
            --location="$COMPOSER_LOCATION" \
            --project="$PROJECT_ID" \
            --format='table(state,createTime,updateTime)' || true
          
          echo "=== Recent Operations ==="
          gcloud composer operations list \
            --locations="$COMPOSER_LOCATION" \
            --project="$PROJECT_ID" \
            --limit=5 || true
